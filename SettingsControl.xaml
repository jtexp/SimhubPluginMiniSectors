<UserControl x:Class="User.PluginMiniSectors.SettingsControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:styles="clr-namespace:SimHub.Plugins.Styles;assembly=SimHub.Plugins"
             xmlns:iconpacks="clr-namespace:MahApps.Metro.IconPacks;assembly=MahApps.Metro.IconPacks.Material"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             mc:Ignorable="d">

    <mah:MetroAnimatedSingleRowTabControl x:Name="MainTabControl"
                                          SelectionChanged="MainTabControl_SelectionChanged"
                                          mah:TabControlHelper.Underlined="TabPanel"
                                          Margin="0,5,0,0">

        <!-- Info Tab (existing content) -->
        <TabItem>
            <TabItem.Header>
                <StackPanel Orientation="Horizontal">
                    <iconpacks:PackIconMaterial Kind="Information" Width="16" Height="16" VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <TextBlock Text="Info" VerticalAlignment="Center" FontSize="14"/>
                </StackPanel>
            </TabItem.Header>
            <ScrollViewer>
                <StackPanel Margin="10">
                    <!-- Version Info Section -->
                    <styles:SHSection Title="VERSION INFO" ShowSeparator="True">
                        <StackPanel Margin="0,10">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="150"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Current Version:" FontWeight="Bold" Margin="0,0,10,5"/>
                                <TextBlock Grid.Row="0" Grid.Column="1" x:Name="CurrentVersionText" Text="Loading..." Margin="0,0,0,5"/>

                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Build Commit:" FontWeight="Bold" Margin="0,0,10,5"/>
                                <TextBlock Grid.Row="1" Grid.Column="1" x:Name="CurrentCommitText" Text="Loading..." Margin="0,0,0,5"
                                           FontFamily="Consolas" FontSize="11"/>
                            </Grid>
                        </StackPanel>
                    </styles:SHSection>

                    <!-- Update Section -->
                    <styles:SHSection Title="UPDATES" ShowSeparator="True">
                        <StackPanel Margin="0,10">
                            <!-- Status Panel (click to copy) -->
                            <Border x:Name="StatusBorder" Background="#333" CornerRadius="4" Padding="15" Margin="0,0,0,15" Visibility="Collapsed"
                                    MouseLeftButtonUp="StatusBorder_Click" Cursor="Hand" ToolTip="Click to copy">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" x:Name="StatusIconPanel">
                                        <iconpacks:PackIconMaterial x:Name="StatusIcon" Kind="Information" Width="20" Height="20"
                                                                    VerticalAlignment="Center" Margin="0,0,10,0"/>
                                        <TextBlock x:Name="StatusText" Text="" VerticalAlignment="Center" TextWrapping="Wrap"/>
                                    </StackPanel>

                                    <!-- Update Details (shown when update available) -->
                                    <StackPanel x:Name="UpdateDetailsPanel" Visibility="Collapsed" Margin="30,10,0,0">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="100"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="New Commit:" Margin="0,0,10,3"/>
                                            <TextBlock Grid.Row="0" Grid.Column="1" x:Name="NewCommitText" FontFamily="Consolas" FontSize="11"/>

                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Built:" Margin="0,0,10,3"/>
                                            <TextBlock Grid.Row="1" Grid.Column="1" x:Name="BuildDateText"/>
                                        </Grid>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- Progress Bar -->
                            <StackPanel x:Name="ProgressPanel" Visibility="Collapsed" Margin="0,0,0,15">
                                <TextBlock x:Name="ProgressText" Text="Downloading..." Margin="0,0,0,5"/>
                                <ProgressBar x:Name="DownloadProgress" Height="20" Minimum="0" Maximum="100"/>
                            </StackPanel>

                            <!-- Buttons -->
                            <StackPanel Orientation="Horizontal">
                                <styles:SHButtonPrimary x:Name="CheckUpdateButton" Click="CheckUpdate_Click"
                                                        Margin="0,0,10,0" MinWidth="150">
                                    Check for Updates
                                </styles:SHButtonPrimary>

                                <styles:SHButtonPrimary x:Name="UpdateButton" Click="Update_Click"
                                                        Visibility="Collapsed" MinWidth="150"
                                                        Background="#0078D4">
                                    Update Now
                                </styles:SHButtonPrimary>
                            </StackPanel>

                            <!-- Note about restart -->
                            <TextBlock Margin="0,15,0,0" FontSize="11" Foreground="#888" TextWrapping="Wrap">
                                Note: Clicking "Update Now" will close SimHub, install the update, and restart SimHub automatically.
                            </TextBlock>
                        </StackPanel>
                    </styles:SHSection>

                    <!-- About Section -->
                    <styles:SHSection Title="ABOUT" ShowSeparator="False">
                        <StackPanel Margin="0,10">
                            <TextBlock TextWrapping="Wrap" Margin="0,0,0,10">
                                MiniSectors tracks timing per corner/section of a track and exposes data properties
                                for use in SimHub dashboards.
                            </TextBlock>
                            <styles:SHLinkButton x:Name="GitHubLink" Click="GitHubLink_Click" HorizontalAlignment="Left">
                                View on GitHub
                            </styles:SHLinkButton>
                        </StackPanel>
                    </styles:SHSection>
                </StackPanel>
            </ScrollViewer>
        </TabItem>

        <!-- Records Tab (new) -->
        <TabItem x:Name="RecordsTab">
            <TabItem.Header>
                <StackPanel Orientation="Horizontal">
                    <iconpacks:PackIconMaterial Kind="Database" Width="16" Height="16" VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <TextBlock Text="Records" VerticalAlignment="Center" FontSize="14"/>
                </StackPanel>
            </TabItem.Header>
            <Grid Margin="10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Header with refresh -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                    <styles:SHButtonPrimary x:Name="RefreshButton" Click="Refresh_Click"
                                            MinWidth="100" Margin="0,0,10,0">
                        Refresh
                    </styles:SHButtonPrimary>
                    <styles:SHButtonSecondary x:Name="LoadAllButton" Click="LoadAll_Click"
                                              MinWidth="100" Margin="0,0,10,0">
                        Load All
                    </styles:SHButtonSecondary>
                    <TextBlock x:Name="RecordCountText" VerticalAlignment="Center"
                               Foreground="#888" FontSize="11"/>
                </StackPanel>

                <!-- Error display -->
                <Border Grid.Row="1" x:Name="ErrorBorder" Background="#442200"
                        CornerRadius="4" Padding="10" Margin="0,0,0,10" Visibility="Collapsed">
                    <TextBlock x:Name="ErrorText" Foreground="Orange" TextWrapping="Wrap"/>
                </Border>

                <!-- DataGrid -->
                <DataGrid Grid.Row="2" x:Name="RecordsGrid"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          CanUserSortColumns="True"
                          CanUserReorderColumns="True"
                          CanUserResizeColumns="True"
                          VirtualizingPanel.IsVirtualizing="True"
                          VirtualizingPanel.VirtualizationMode="Recycling"
                          EnableRowVirtualization="True">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Track" Binding="{Binding TrackId}" Width="150"/>
                        <DataGridTextColumn Header="Sector" Binding="{Binding SectorNumber}" Width="60"/>
                        <DataGridTextColumn Header="Time" Binding="{Binding BestTimeFormatted}" Width="90"/>
                        <DataGridTextColumn Header="Car" Binding="{Binding CarModel}" Width="150"/>
                        <DataGridTextColumn Header="Weather" Binding="{Binding WeatherType}" Width="80"/>
                        <DataGridTextColumn Header="Track C" Binding="{Binding TrackTempCelsius, StringFormat={}{0:F1}}" Width="70"/>
                        <DataGridTextColumn Header="Air C" Binding="{Binding AirTempCelsius, StringFormat={}{0:F1}}" Width="60"/>
                        <DataGridTextColumn Header="Recorded" Binding="{Binding RecordedAt, StringFormat={}{0:yyyy-MM-dd HH:mm}}" Width="130"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </TabItem>

    </mah:MetroAnimatedSingleRowTabControl>
</UserControl>
